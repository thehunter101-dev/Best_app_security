{% extends 'home.jinja' %}
<title>{% block title %}{{ title }}{% endblock %}</title>
{% load static %} {% block styles %}
<link
  rel="stylesheet"
  href="{% static 'styles/form.css' %}"
  type="text/css"
  media="screen"
/>
{% endblock styles %} {% block content %}
<section class="dark:bg-principal">
  <div class="text-center" data-aos="fade" data-aos-delay="200">
    <div class="sm:pt-8 lg:pt-4">
      <h1
        class="rounded-2xl bg-indigo-500 px-2 py-1 text-white uppercase text-4xl"
      >
        {{ title1 }}
      </h1>
    </div>

    {% if form.non_field_errors %}
    <div class="mx-4 lg:mx-20 my-6" data-aos="fade-up">
      <div
        class="bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500 p-4 rounded-lg max-w-4xl mx-auto"
      >
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <i
              class="fa-solid fa-exclamation-triangle text-red-500 text-lg"
            ></i>
          </div>
          <div class="ml-3">
            <h3 class="text-red-800 dark:text-red-200 font-medium">
              Se encontraron errores en el formulario:
            </h3>
            <div class="mt-2 text-red-700 dark:text-red-300">
              <ul class="list-disc list-inside space-y-1">
                {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="space-y-6 py-4">
      {% csrf_token %}
      <div class="mx-4 lg:mx-20" data-aos="fade">
        <div
          class="bg-white dark:bg-secundario rounded-3xl p-8 max-w-5xl mx-auto"
          data-aos="fade-up"
          data-aos-delay="200"
        >
          <!-- Profile Image Preview -->
          <div class="text-center mb-8">
            <div class="relative inline-block">
              <img
                id="imagePreview"
                src="{% if form.instance.image %}{{ form.instance.image.url }}{% else %}{% static 'img/usuario_anonimo.png' %}{% endif %}"
                alt="Vista previa de imagen"
                class="bg-gray-100 dark:bg-principal rounded-full w-32 h-32 mx-auto object-cover mb-2 border-2 border-gray-300 dark:border-gray-600"
              />
              <label
                for="{{ form.image.id_for_label }}"
                class="absolute bottom-0 right-0 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full cursor-pointer"
                title="Cambiar imagen"
              >
                <i class="fa-solid fa-camera"></i>
              </label>
            </div>
            {{ form.image }}
            <!-- Hidden by default, triggered by label -->
            {% if form.image.errors %}
            <div class="mt-2 text-red-600 dark:text-red-400 text-sm">
              {% for error in form.image.errors %}
              <div class="flex items-center mt-1 justify-center">
                <i class="fa-solid fa-circle-exclamation text-xs mr-2"></i>{{
                error }}
              </div>
              {% endfor %}
            </div>
            {% endif %}
            <h2 class="dark:text-blue-300 text-2xl font-Pacifico mt-2">
              {% if form.instance.pk %}{{ form.instance.username }}{% else
              %}Nuevo Usuario{% endif %}
            </h2>
          </div>

          <!-- Form Fields Grid -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4"
          >
            {% for field in form %} {% if field.name != 'image' %} {# Image
            field is handled above #}
            <div
              class="field-container {% if field.errors %}has-error{% endif %} {% if field.name == 'groups' or field.name == 'user_permissions' %}lg:col-span-3{% elif field.field.widget.input_type == 'checkbox' %}lg:col-span-1 flex items-center mt-6{% else %}lg:col-span-1{% endif %}"
            >
              {% if field.field.widget.input_type == 'checkbox' %} {{ field }}
              <label
                for="{{ field.id_for_label }}"
                class="font-black uppercase text-sm ml-2 {% if field.errors %}text-red-600 dark:text-red-400{% else %}dark:text-blue-300{% endif %}"
              >
                {{ field.label }} {% if field.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>
              {% else %}
              <label
                for="{{ field.id_for_label }}"
                class="font-black uppercase text-sm block mb-1 {% if field.errors %}text-red-600 dark:text-red-400{% else %}dark:text-blue-300{% endif %}"
              >
                {{ field.label }} {% if field.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>
              <div class="relative">
                {{ field }} {% if field.errors %}
                <div
                  class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
                >
                  <i class="fa-solid fa-exclamation-circle text-red-500"></i>
                </div>
                {% endif %}
              </div>
              {% endif %} {% if field.help_text %}
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                {{ field.help_text|safe }}
              </p>
              {% endif %} {% if field.errors %}
              <div class="mt-1 text-red-600 dark:text-red-400 text-xs">
                {% for error in field.errors %}
                <div class="flex items-center mt-1">
                  <i class="fa-solid fa-circle-exclamation text-xs mr-1"></i>{{
                  error }}
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
            {% endif %} {% endfor %}
          </div>

          <!-- Action Buttons -->
          <div
            class="flex flex-col md:flex-row justify-center items-center mt-10 space-y-3 md:space-y-0 md:space-x-8"
          >
            <button
              type="submit"
              class="w-full md:w-auto bg-blue-700 hover:bg-blue-800 text-white py-3 px-8 rounded-lg flex items-center justify-center transition-all duration-300 font-medium shadow-lg hover:shadow-xl"
            >
              <i class="fa-solid fa-save mr-2"></i>{{ grabar }}
            </button>
            <a
              class="w-full md:w-auto bg-red-700 hover:bg-red-800 text-white py-3 px-8 rounded-lg flex items-center justify-center transition-all duration-300 font-medium shadow-lg hover:shadow-xl"
              href="{{ back_url }}"
            >
              <i class="fa-solid fa-xmark mr-2"></i>Cancelar
            </a>
          </div>
        </div>
      </div>
    </form>
  </div>
</section>
{% endblock %} {% block scripts %}
<script type="text/javascript" src="{% static 'scripts/form.js' %}"></script>
{# Assuming a generic form.js for icon preview if needed, or add specific script
#}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const imageInput = document.getElementById('{{ form.image.id_for_label }}');
      const imagePreview = document.getElementById('imagePreview');
      const defaultImage = "{% static 'img/usuario_anonimo.png' %}";

      if (imageInput && imagePreview) {
          // Hide the default file input
          imageInput.style.display = 'none';

          imageInput.addEventListener('change', function(event) {
              const file = event.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      imagePreview.src = e.target.result;
                  }
                  reader.readAsDataURL(file);
              } else {
                  // If no file is selected (e.g., user cancels), revert to original or default
                  // This part depends on whether you want to show original image or default if selection is cleared
                  // For simplicity, let's assume if form.instance.image.url exists, it means there's an existing image
                  {% if form.instance.image and form.instance.image.url %}
                  imagePreview.src = "{{ form.instance.image.url }}";
                  {% else %}
                  imagePreview.src = defaultImage;
                  {% endif %}
              }
          });
      }
  });
</script>
{% endblock scripts %}
